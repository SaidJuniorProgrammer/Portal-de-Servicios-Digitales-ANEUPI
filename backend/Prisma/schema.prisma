// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Estados del flujo) ---

enum Rol {
  USER
  ADMIN
}

// El corazón del flujo
enum EstadoSolicitud {
  PENDIENTE_PAGO  // Usuario creó la solicitud, pero no ha subido comprobante
  EN_REVISION     // Usuario subió comprobante, Admin debe revisar
  APROBADO        // Admin aprobó, PDF generado y listo para descargar
  RECHAZADO       // Admin rechazó el comprobante
}

// --- MODELOS ---

model Usuario {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  password     String
  rol          Rol      @default(USER)
  fechaRegistro DateTime @default(now())

  // Datos personales para rellenar los PDFs
  nombreCompleto String
  cedula         String   @unique
  direccion      String?
  telefono       String?

  solicitudes    Solicitud[]

  @@map("usuarios")
}

// Catálogo de documentos disponibles (Ej: Certificado Bancario, $1.00)
model TipoDocumento {
  id            Int      @id @default(autoincrement())
  nombre        String   // Ej: "Certificado de Cuenta Activa"
  descripcion   String?
  precio        Decimal  @db.Decimal(10, 2) // Ej: 1.00
  activo        Boolean  @default(true)
  
  // Nombre interno de la plantilla (ej: "plantilla_certificado_v1")
  codigoPlantilla String 

  solicitudes   Solicitud[]

  @@map("tipos_documentos")
}

// La tabla central que une todo
model Solicitud {
  id               Int      @id @default(autoincrement())
  
  usuarioId        Int
  usuario          Usuario  @relation(fields: [usuarioId], references: [id])

  tipoDocumentoId  Int
  tipoDocumento    TipoDocumento @relation(fields: [tipoDocumentoId], references: [id])

  // Datos del proceso
  estado           EstadoSolicitud @default(PENDIENTE_PAGO)
  precioAlSolicitar Decimal        @db.Decimal(10, 2) // Guardamos el precio histórico
  fechaSolicitud   DateTime        @default(now())
  fechaAprobacion  DateTime?

  // Archivos
  comprobantePagoUrl String? // La foto que sube el usuario
  nombreArchivo      String? // Nombre del archivo subido
  extensionArchivo   String? // Extensión del archivo
  pdfGeneradoUrl     String? // El PDF final que genera el sistema
  observacionAdmin   String? // Si se rechaza, por qué

  @@map("solicitudes")
}